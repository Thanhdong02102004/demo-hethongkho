<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω v·ªã tr√≠ kho - Qu·∫£n l√Ω kho</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .location-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }
        .location-card h3 {
            margin-top: 0;
            color: #065f46;
        }
        .warehouse-map {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .map-cell {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .map-cell:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
        }
        .map-cell.occupied {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        .map-cell.empty {
            background: #d1fae5;
            border-color: #10b981;
        }
        .map-cell.full {
            background: #fee2e2;
            border-color: #ef4444;
        }
        .location-info {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .product-count {
            font-weight: bold;
            color: #1f2937;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-danger { background: #ef4444; }
        .btn-info { background: #06b6d4; }
        .location-table {
            margin-top: 20px;
        }
        .location-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .status-available { color: #10b981; font-weight: bold; }
        .status-occupied { color: #f59e0b; font-weight: bold; }
        .status-full { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <a href="home.html">Trang ch·ªß</a>
            <a href="catalog.html">Danh m·ª•c</a>
            <a href="operations.html">Nghi·ªáp v·ª• kho</a>
            <a href="reports.html">B√°o c√°o</a>
            <a href="users.html" id="navUsers">Ng∆∞·ªùi d√πng</a>
            <a href="search.html">Tra c·ª©u</a>
            <a href="customers.html">Kh√°ch h√†ng</a>
            <a href="invoices.html">H√≥a ƒë∆°n</a>
            <a href="locations.html" class="active">V·ªã tr√≠ kho</a>
        </aside>
        <main class="content">
            <header class="page-header">
                <h1>üìç Qu·∫£n l√Ω v·ªã tr√≠ kho</h1>
                <div class="grow"></div>
                <button id="btnRefresh" class="btn secondary">üîÑ L√†m m·ªõi</button>
            </header>

            <!-- Th·ªëng k√™ v·ªã tr√≠ -->
            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalLocations">0</div>
                    <div class="stat-label">T·ªïng v·ªã tr√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="availableLocations">0</div>
                    <div class="stat-label">V·ªã tr√≠ tr·ªëng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="occupiedLocations">0</div>
                    <div class="stat-label">V·ªã tr√≠ c√≥ h√†ng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fullLocations">0</div>
                    <div class="stat-label">V·ªã tr√≠ ƒë·∫ßy</div>
                </div>
            </section>

            <!-- Tabs ch√≠nh -->
            <section class="tabs">
                <button class="tab active" data-tab="manage">üèóÔ∏è Qu·∫£n l√Ω v·ªã tr√≠</button>
                <button class="tab" data-tab="map">üó∫Ô∏è B·∫£n ƒë·ªì kho</button>
                <button class="tab" data-tab="assign">üì¶ G√°n s·∫£n ph·∫©m</button>
                <button class="tab" data-tab="report">üìä B√°o c√°o</button>
            </section>

            <!-- Qu·∫£n l√Ω v·ªã tr√≠ -->
            <section id="manage" class="panel">
                <h2>üèóÔ∏è Qu·∫£n l√Ω v·ªã tr√≠ kho</h2>
                <div class="transaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Kho</label>
                            <select id="locationWh" required title="Ch·ªçn kho">
                                <option value="">Ch·ªçn kho...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M√£ v·ªã tr√≠</label>
                            <input id="locationCode" placeholder="A-01-01" required />
                        </div>
                        <div class="form-group">
                            <label>T√™n v·ªã tr√≠</label>
                            <input id="locationName" placeholder="K·ªá A, T·∫ßng 1, √î 1" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lo·∫°i v·ªã tr√≠</label>
                            <select id="locationType" required title="Ch·ªçn lo·∫°i v·ªã tr√≠">
                                <option value="SHELF">K·ªá</option>
                                <option value="FLOOR">S√†n</option>
                                <option value="PALLET">Pallet</option>
                                <option value="COLD">Kho l·∫°nh</option>
                                <option value="HAZARDOUS">Kho nguy hi·ªÉm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Di·ªán t√≠ch (m¬≤)</label>
                            <input type="number" id="locationArea" placeholder="0" min="0" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>S·ª©c ch·ª©a t·ªëi ƒëa</label>
                            <input type="number" id="locationCapacity" placeholder="0" min="0" step="1" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tr·∫°ng th√°i</label>
                            <select id="locationStatus" required title="Ch·ªçn tr·∫°ng th√°i">
                                <option value="AVAILABLE">S·∫µn s√†ng</option>
                                <option value="MAINTENANCE">B·∫£o tr√¨</option>
                                <option value="RESERVED">ƒê√£ ƒë·∫∑t</option>
                                <option value="DISABLED">V√¥ hi·ªáu h√≥a</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ghi ch√∫</label>
                            <textarea id="locationNote" rows="2" placeholder="Ghi ch√∫ v·ªÅ v·ªã tr√≠"></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnAddLocation" class="btn btn-success">‚ûï Th√™m v·ªã tr√≠</button>
                        <button id="btnUpdateLocation" class="btn btn-warning" style="display: none;">‚úèÔ∏è C·∫≠p nh·∫≠t</button>
                        <button id="btnClearLocation" class="btn secondary">üóëÔ∏è X√≥a tr·∫Øng</button>
                    </div>
                </div>
                
                <h3>Danh s√°ch v·ªã tr√≠</h3>
                <table class="table location-table" id="tblLocations">
                    <thead>
                        <tr>
                            <th>M√£ v·ªã tr√≠</th>
                            <th>T√™n v·ªã tr√≠</th>
                            <th>Kho</th>
                            <th>Lo·∫°i</th>
                            <th>Di·ªán t√≠ch</th>
                            <th>S·ª©c ch·ª©a</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- B·∫£n ƒë·ªì kho -->
            <section id="map" class="panel hidden">
                <h2>üó∫Ô∏è B·∫£n ƒë·ªì kho</h2>
                <div class="transaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ch·ªçn kho ƒë·ªÉ xem b·∫£n ƒë·ªì</label>
                            <select id="mapWarehouse" required title="Ch·ªçn kho ƒë·ªÉ xem b·∫£n ƒë·ªì">
                                <option value="">Ch·ªçn kho...</option>
                            </select>
                        </div>
                                                 <div class="form-group">
                             <label>B·ªô l·ªçc</label>
                             <select id="mapFilter" title="B·ªô l·ªçc v·ªã tr√≠ kho">
                                 <option value="ALL">T·∫•t c·∫£</option>
                                 <option value="AVAILABLE">V·ªã tr√≠ tr·ªëng</option>
                                 <option value="OCCUPIED">C√≥ h√†ng</option>
                                 <option value="FULL">ƒê·∫ßy</option>
                             </select>
                         </div>
                    </div>
                </div>
                
                <div class="warehouse-map">
                    <h3>B·∫£n ƒë·ªì v·ªã tr√≠</h3>
                    <div id="mapContainer">
                        <p class="muted">Ch·ªçn kho ƒë·ªÉ xem b·∫£n ƒë·ªì v·ªã tr√≠</p>
                    </div>
                </div>
            </section>

            <!-- G√°n s·∫£n ph·∫©m -->
            <section id="assign" class="panel hidden">
                <h2>üì¶ G√°n s·∫£n ph·∫©m v√†o v·ªã tr√≠</h2>
                <div class="transaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Kho</label>
                            <select id="assignWh" required title="Ch·ªçn kho">
                                <option value="">Ch·ªçn kho...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>S·∫£n ph·∫©m</label>
                            <select id="assignProduct" required title="Ch·ªçn s·∫£n ph·∫©m">
                                <option value="">Ch·ªçn s·∫£n ph·∫©m...</option>
                            </select>
                        </div>
                                                 <div class="form-group">
                             <label>V·ªã tr√≠</label>
                             <select id="assignLocation" required title="Ch·ªçn v·ªã tr√≠ trong kho">
                                 <option value="">Ch·ªçn v·ªã tr√≠...</option>
                             </select>
                         </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="assignQty" placeholder="0" min="0" step="1" required />
                        </div>
                        <div class="form-group">
                            <label>T·ªìn kho hi·ªán t·∫°i</label>
                            <input type="text" id="assignCurrentStock" readonly />
                        </div>
                        <div class="form-group">
                            <label>Ghi ch√∫</label>
                            <textarea id="assignNote" rows="2" placeholder="Ghi ch√∫ g√°n s·∫£n ph·∫©m"></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnAssignProduct" class="btn btn-success">üì¶ G√°n s·∫£n ph·∫©m</button>
                        <button id="btnUnassignProduct" class="btn btn-danger">‚ùå B·ªè g√°n</button>
                        <button id="btnAssignClear" class="btn secondary">üóëÔ∏è X√≥a tr·∫Øng</button>
                    </div>
                </div>
                
                <h3>Danh s√°ch s·∫£n ph·∫©m theo v·ªã tr√≠</h3>
                <table class="table location-table" id="tblAssignments">
                    <thead>
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>V·ªã tr√≠</th>
                            <th>Kho</th>
                            <th class="right">S·ªë l∆∞·ª£ng</th>
                            <th>Ng√†y g√°n</th>
                            <th>Ghi ch√∫</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- B√°o c√°o v·ªã tr√≠ -->
            <section id="report" class="panel hidden">
                <h2>üìä B√°o c√°o v·ªã tr√≠ kho</h2>
                <div class="transaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportWh">Kho</label>
                            <select id="reportWh" title="Ch·ªçn kho ƒë·ªÉ b√°o c√°o">
                                <option value="">T·∫•t c·∫£ kho</option>
                            </select>
                        </div>
                             <label>Lo·∫°i v·ªã tr√≠</label>
                             <select id="reportType" title="Ch·ªçn lo·∫°i v·ªã tr√≠ ƒë·ªÉ b√°o c√°o">
                                 <option value="">T·∫•t c·∫£ lo·∫°i</option>
                                 <option value="SHELF">K·ªá</option>
                                 <option value="FLOOR">S√†n</option>
                                 <option value="PALLET">Pallet</option>
                                 <option value="COLD">Kho l·∫°nh</option>
                                 <option value="HAZARDOUS">Kho nguy hi·ªÉm</option>
                             </select>
                         </div>
                        <div class="form-group">
                            <label>Tr·∫°ng th√°i</label>
                            <select id="reportStatus">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="AVAILABLE">S·∫µn s√†ng</option>
                                <option value="OCCUPIED">C√≥ h√†ng</option>
                                <option value="FULL">ƒê·∫ßy</option>
                                <option value="MAINTENANCE">B·∫£o tr√¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnGenerateLocationReport" class="btn btn-info">üìä T·∫°o b√°o c√°o</button>
                        <button id="btnExportLocationReport" class="btn btn-success">üì• Xu·∫•t Excel</button>
                        <button id="btnPrintLocationReport" class="btn btn-warning">üñ®Ô∏è In b√°o c√°o</button>
                    </div>
                </div>
                
                <div class="location-grid">
                    <div class="location-card">
                        <h3>üìà Th·ªëng k√™ s·ª≠ d·ª•ng</h3>
                        <div id="locationUsageStats"></div>
                    </div>
                    <div class="location-card">
                        <h3>‚ö†Ô∏è C·∫£nh b√°o</h3>
                        <div id="locationAlerts"></div>
                    </div>
                </div>
                
                <table class="table location-table" id="tblLocationReport">
                    <thead>
                        <tr>
                            <th>V·ªã tr√≠</th>
                            <th>Kho</th>
                            <th>Lo·∫°i</th>
                            <th>Di·ªán t√≠ch</th>
                            <th>S·ª©c ch·ª©a</th>
                            <th>ƒê√£ s·ª≠ d·ª•ng</th>
                            <th>T·ª∑ l·ªá s·ª≠ d·ª•ng</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </main>
    </div>

    <script src="assets/js/storage.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        guardAuthenticated();
        const current = getCurrentUser();
        if (current.role !== 'Admin') document.getElementById('navUsers').style.display = 'none';

        // Kh·ªüi t·∫°o d·ªØ li·ªáu
        const products = storage.get('products', []);
        const warehouses = storage.get('warehouses', []);
        const locations = storage.get('locations', []);
        const transactions = storage.get('transactions', []);

        // C·∫≠p nh·∫≠t th·ªëng k√™ nhanh
        function updateQuickStats() {
            const totalLocations = locations.length;
            const availableLocations = locations.filter(l => l.status === 'AVAILABLE').length;
            const occupiedLocations = locations.filter(l => l.status === 'OCCUPIED').length;
            const fullLocations = locations.filter(l => l.status === 'FULL').length;

            document.getElementById('totalLocations').textContent = totalLocations.toLocaleString('vi-VN');
            document.getElementById('availableLocations').textContent = availableLocations.toLocaleString('vi-VN');
            document.getElementById('occupiedLocations').textContent = occupiedLocations.toLocaleString('vi-VN');
            document.getElementById('fullLocations').textContent = fullLocations.toLocaleString('vi-VN');
        }

        // Kh·ªüi t·∫°o form
        function initializeForms() {
            // Populate warehouse selects
            const warehouseOptions = warehouses.map(w => 
                `<option value="${w.id}">${w.code} - ${w.name}</option>`
            ).join('');
            
            ['locationWh', 'mapWarehouse', 'assignWh', 'reportWh'].forEach(id => {
                if (document.getElementById(id)) {
                    document.getElementById(id).innerHTML = '<option value="">Ch·ªçn kho...</option>' + warehouseOptions;
                }
            });

            // Populate product selects
            const productOptions = products.map(p => 
                `<option value="${p.id}">${p.code} - ${p.name}</option>`
            ).join('');
            
            if (document.getElementById('assignProduct')) {
                document.getElementById('assignProduct').innerHTML = '<option value="">Ch·ªçn s·∫£n ph·∫©m...</option>' + productOptions;
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeForms();
            updateQuickStats();
        });

        // Refresh button
        document.getElementById('btnRefresh').addEventListener('click', function() {
            updateQuickStats();
            alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu!');
        });
    </script>
</body>
</html>
