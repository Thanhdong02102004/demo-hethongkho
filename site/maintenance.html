<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω b·∫£o tr√¨ kho - Qu·∫£n l√Ω kho</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .maintenance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .maintenance-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #f59e0b;
        }
        .maintenance-card h3 {
            margin-top: 0;
            color: #92400e;
        }
        .maintenance-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-danger { background: #ef4444; }
        .btn-info { background: #06b6d4; }
        .maintenance-table {
            margin-top: 20px;
        }
        .maintenance-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-inprogress { color: #3b82f6; font-weight: bold; }
        .status-completed { color: #10b981; font-weight: bold; }
        .status-cancelled { color: #ef4444; font-weight: bold; }
        .priority-high { background: #fee2e2; color: #991b1b; }
        .priority-medium { background: #fef3c7; color: #92400e; }
        .priority-low { background: #d1fae5; color: #065f46; }
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <a href="home.html">Trang ch·ªß</a>
            <a href="catalog.html">Danh m·ª•c</a>
            <a href="operations.html">Nghi·ªáp v·ª• kho</a>
            <a href="reports.html">B√°o c√°o</a>
            <a href="users.html" id="navUsers">Ng∆∞·ªùi d√πng</a>
            <a href="search.html">Tra c·ª©u</a>
            <a href="customers.html">Kh√°ch h√†ng</a>
            <a href="invoices.html">H√≥a ƒë∆°n</a>
            <a href="locations.html">V·ªã tr√≠ kho</a>
            <a href="maintenance.html" class="active">B·∫£o tr√¨ kho</a>
        </aside>
        <main class="content">
            <header class="page-header">
                <h1>üîß Qu·∫£n l√Ω b·∫£o tr√¨ kho</h1>
                <div class="grow"></div>
                <button id="btnRefresh" class="btn secondary">üîÑ L√†m m·ªõi</button>
            </header>

            <!-- Th·ªëng k√™ b·∫£o tr√¨ -->
            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalMaintenance">0</div>
                    <div class="stat-label">T·ªïng y√™u c·∫ßu</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingMaintenance">0</div>
                    <div class="stat-label">Ch·ªù x·ª≠ l√Ω</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inProgressMaintenance">0</div>
                    <div class="stat-label">ƒêang th·ª±c hi·ªán</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedMaintenance">0</div>
                    <div class="stat-label">Ho√†n th√†nh</div>
                </div>
            </section>

            <!-- Tabs ch√≠nh -->
            <section class="tabs">
                <button class="tab active" data-tab="plan">üìã L·∫≠p k·∫ø ho·∫°ch</button>
                <button class="tab" data-tab="track">üìä Theo d√µi</button>
                <button class="tab" data-tab="incident">üö® B√°o c√°o s·ª± c·ªë</button>
                <button class="tab" data-tab="staff">üë∑ Nh√¢n vi√™n</button>
            </section>

            <!-- L·∫≠p k·∫ø ho·∫°ch b·∫£o tr√¨ -->
            <section id="plan" class="panel">
                <h2>üìã L·∫≠p k·∫ø ho·∫°ch b·∫£o tr√¨</h2>
                <div class="maintenance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Kho c·∫ßn b·∫£o tr√¨</label>
                            <select id="maintenanceWh" required title="Ch·ªçn kho c·∫ßn b·∫£o tr√¨">
                                <option value="">Ch·ªçn kho...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lo·∫°i b·∫£o tr√¨</label>
                            <select id="maintenanceType" required title="Ch·ªçn lo·∫°i b·∫£o tr√¨">
                                <option value="">Ch·ªçn lo·∫°i...</option>
                                <option value="PREVENTIVE">B·∫£o tr√¨ ph√≤ng ng·ª´a</option>
                                <option value="CORRECTIVE">B·∫£o tr√¨ s·ª≠a ch·ªØa</option>
                                <option value="EMERGENCY">B·∫£o tr√¨ kh·∫©n c·∫•p</option>
                                <option value="INSPECTION">Ki·ªÉm tra ƒë·ªãnh k·ª≥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M·ª©c ƒë·ªô ∆∞u ti√™n</label>
                            <select id="maintenancePriority" required title="Ch·ªçn m·ª©c ƒë·ªô ∆∞u ti√™n">
                                <option value="">Ch·ªçn m·ª©c ƒë·ªô...</option>
                                <option value="HIGH">Cao</option>
                                <option value="MEDIUM">Trung b√¨nh</option>
                                <option value="LOW">Th·∫•p</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input type="date" id="maintenanceStartDate" required />
                        </div>
                        <div class="form-group">
                            <label>Ng√†y d·ª± ki·∫øn ho√†n th√†nh</label>
                            <input type="date" id="maintenanceEndDate" required />
                        </div>
                        <div class="form-group">
                            <label>Ng∆∞·ªùi ph·ª• tr√°ch</label>
                            <select id="maintenanceStaff" required title="Ch·ªçn nh√¢n vi√™n ph·ª• tr√°ch">
                                <option value="">Ch·ªçn nh√¢n vi√™n...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√¥ t·∫£ c√¥ng vi·ªác</label>
                            <textarea id="maintenanceDescription" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác b·∫£o tr√¨" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>V·∫≠t t∆∞ c·∫ßn thi·∫øt</label>
                            <textarea id="maintenanceMaterials" rows="3" placeholder="Danh s√°ch v·∫≠t t∆∞, thi·∫øt b·ªã c·∫ßn thi·∫øt"></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnCreateMaintenance" class="btn btn-success">üìã T·∫°o k·∫ø ho·∫°ch</button>
                        <button id="btnUpdateMaintenance" class="btn btn-warning" style="display: none;">‚úèÔ∏è C·∫≠p nh·∫≠t</button>
                        <button id="btnClearMaintenance" class="btn secondary">üóëÔ∏è X√≥a tr·∫Øng</button>
                    </div>
                </div>
                
                <h3>Danh s√°ch k·∫ø ho·∫°ch b·∫£o tr√¨</h3>
                <table class="table maintenance-table" id="tblMaintenance">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>Kho</th>
                            <th>Lo·∫°i</th>
                            <th>M·ª©c ƒë·ªô</th>
                            <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                            <th>Ng√†y ho√†n th√†nh</th>
                            <th>Ng∆∞·ªùi ph·ª• tr√°ch</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- Theo d√µi ti·∫øn ƒë·ªô -->
            <section id="track" class="panel hidden">
                <h2>üìä Theo d√µi ti·∫øn ƒë·ªô b·∫£o tr√¨</h2>
                <div class="maintenance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ch·ªçn k·∫ø ho·∫°ch b·∫£o tr√¨</label>
                            <select id="trackMaintenance" required title="Ch·ªçn k·∫ø ho·∫°ch b·∫£o tr√¨ ƒë·ªÉ theo d√µi">
                                <option value="">Ch·ªçn k·∫ø ho·∫°ch...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tr·∫°ng th√°i hi·ªán t·∫°i</label>
                            <select id="trackStatus" required title="C·∫≠p nh·∫≠t tr·∫°ng th√°i">
                                <option value="">Ch·ªçn tr·∫°ng th√°i...</option>
                                <option value="PENDING">Ch·ªù x·ª≠ l√Ω</option>
                                <option value="INPROGRESS">ƒêang th·ª±c hi·ªán</option>
                                <option value="COMPLETED">Ho√†n th√†nh</option>
                                <option value="CANCELLED">ƒê√£ h·ªßy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ti·∫øn ƒë·ªô (%)</label>
                            <input type="number" id="trackProgress" placeholder="0" min="0" max="100" step="5" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ghi ch√∫ ti·∫øn ƒë·ªô</label>
                            <textarea id="trackNotes" rows="3" placeholder="Ghi ch√∫ v·ªÅ ti·∫øn ƒë·ªô th·ª±c hi·ªán"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Ng√†y c·∫≠p nh·∫≠t</label>
                            <input type="date" id="trackUpdateDate" />
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnUpdateProgress" class="btn btn-info">üìä C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô</button>
                        <button id="btnCompleteMaintenance" class="btn btn-success">‚úÖ Ho√†n th√†nh</button>
                        <button id="btnCancelMaintenance" class="btn btn-danger">‚ùå H·ªßy b·ªè</button>
                    </div>
                </div>
                
                <div class="maintenance-grid">
                    <div class="maintenance-card">
                        <h3>üìà Ti·∫øn ƒë·ªô t·ªïng quan</h3>
                        <div id="progressOverview"></div>
                    </div>
                    <div class="maintenance-card">
                        <h3>‚è∞ L·ªãch tr√¨nh</h3>
                        <div id="maintenanceSchedule"></div>
                    </div>
                </div>
                
                <h3>L·ªãch s·ª≠ c·∫≠p nh·∫≠t</h3>
                <table class="table maintenance-table" id="tblProgressHistory">
                    <thead>
                        <tr>
                            <th>Ng√†y</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ti·∫øn ƒë·ªô</th>
                            <th>Ghi ch√∫</th>
                            <th>Ng∆∞·ªùi c·∫≠p nh·∫≠t</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- B√°o c√°o s·ª± c·ªë -->
            <section id="incident" class="panel hidden">
                <h2>üö® B√°o c√°o s·ª± c·ªë</h2>
                <div class="maintenance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Kho x·∫£y ra s·ª± c·ªë</label>
                            <select id="incidentWh" required title="Ch·ªçn kho x·∫£y ra s·ª± c·ªë">
                                <option value="">Ch·ªçn kho...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lo·∫°i s·ª± c·ªë</label>
                            <select id="incidentType" required title="Ch·ªçn lo·∫°i s·ª± c·ªë">
                                <option value="">Ch·ªçn lo·∫°i...</option>
                                <option value="EQUIPMENT">Thi·∫øt b·ªã h·ªèng</option>
                                <option value="STRUCTURE">K·∫øt c·∫•u kho</option>
                                <option value="SAFETY">An to√†n</option>
                                <option value="ENVIRONMENT">M√¥i tr∆∞·ªùng</option>
                                <option value="OTHER">Kh√°c</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M·ª©c ƒë·ªô nghi√™m tr·ªçng</label>
                            <select id="incidentSeverity" required title="Ch·ªçn m·ª©c ƒë·ªô nghi√™m tr·ªçng">
                                <option value="">Ch·ªçn m·ª©c ƒë·ªô...</option>
                                <option value="CRITICAL">Nghi√™m tr·ªçng</option>
                                <option value="HIGH">Cao</option>
                                <option value="MEDIUM">Trung b√¨nh</option>
                                <option value="LOW">Th·∫•p</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Th·ªùi gian x·∫£y ra</label>
                            <input type="datetime-local" id="incidentTime" required />
                        </div>
                        <div class="form-group">
                            <label>Ng∆∞·ªùi b√°o c√°o</label>
                            <input id="incidentReporter" placeholder="T√™n ng∆∞·ªùi b√°o c√°o" required />
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</label>
                            <input type="tel" id="incidentPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√¥ t·∫£ s·ª± c·ªë</label>
                            <textarea id="incidentDescription" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt s·ª± c·ªë x·∫£y ra" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>H√†nh ƒë·ªông kh·∫Øc ph·ª•c</label>
                            <textarea id="incidentAction" rows="4" placeholder="C√°c h√†nh ƒë·ªông ƒë√£ th·ª±c hi·ªán ƒë·ªÉ kh·∫Øc ph·ª•c"></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnReportIncident" class="btn btn-danger">üö® B√°o c√°o s·ª± c·ªë</button>
                        <button id="btnIncidentClear" class="btn secondary">üóëÔ∏è X√≥a tr·∫Øng</button>
                    </div>
                </div>
                
                <h3>Danh s√°ch s·ª± c·ªë</h3>
                <table class="table maintenance-table" id="tblIncidents">
                    <thead>
                        <tr>
                            <th>M√£ s·ª± c·ªë</th>
                            <th>Kho</th>
                            <th>Lo·∫°i</th>
                            <th>M·ª©c ƒë·ªô</th>
                            <th>Th·ªùi gian</th>
                            <th>Ng∆∞·ªùi b√°o c√°o</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- Qu·∫£n l√Ω nh√¢n vi√™n -->
            <section id="staff" class="panel hidden">
                <h2>üë∑ Qu·∫£n l√Ω nh√¢n vi√™n b·∫£o tr√¨</h2>
                <div class="maintenance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>H·ªç v√† t√™n</label>
                            <input id="staffName" placeholder="H·ªç v√† t√™n nh√¢n vi√™n" required />
                        </div>
                        <div class="form-group">
                            <label>M√£ nh√¢n vi√™n</label>
                            <input id="staffCode" placeholder="NV-BT-001" required />
                        </div>
                        <div class="form-group">
                            <label>Ch·ª©c v·ª•</label>
                            <select id="staffPosition" required title="Ch·ªçn ch·ª©c v·ª•">
                                <option value="">Ch·ªçn ch·ª©c v·ª•...</option>
                                <option value="TECHNICIAN">K·ªπ thu·∫≠t vi√™n</option>
                                <option value="ENGINEER">K·ªπ s∆∞</option>
                                <option value="SUPERVISOR">Gi√°m s√°t</option>
                                <option value="MANAGER">Qu·∫£n l√Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Chuy√™n m√¥n</label>
                            <select id="staffSpecialty" required title="Ch·ªçn chuy√™n m√¥n">
                                <option value="">Ch·ªçn chuy√™n m√¥n...</option>
                                <option value="ELECTRICAL">ƒêi·ªán</option>
                                <option value="MECHANICAL">C∆° kh√≠</option>
                                <option value="HVAC">ƒêi·ªÅu h√≤a</option>
                                <option value="STRUCTURE">K·∫øt c·∫•u</option>
                                <option value="GENERAL">T·ªïng h·ª£p</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="staffPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required />
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="staffEmail" placeholder="email@example.com" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tr·∫°ng th√°i</label>
                            <select id="staffStatus" required title="Ch·ªçn tr·∫°ng th√°i">
                                <option value="ACTIVE">ƒêang l√†m vi·ªác</option>
                                <option value="INACTIVE">T·∫°m ngh·ªâ</option>
                                <option value="RESIGNED">ƒê√£ ngh·ªâ vi·ªác</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ghi ch√∫</label>
                            <textarea id="staffNote" rows="2" placeholder="Ghi ch√∫ v·ªÅ nh√¢n vi√™n"></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="btnAddStaff" class="btn btn-success">üë∑ Th√™m nh√¢n vi√™n</button>
                        <button id="btnUpdateStaff" class="btn btn-warning" style="display: none;">‚úèÔ∏è C·∫≠p nh·∫≠t</button>
                        <button id="btnStaffClear" class="btn secondary">üóëÔ∏è X√≥a tr·∫Øng</button>
                    </div>
                </div>
                
                <h3>Danh s√°ch nh√¢n vi√™n b·∫£o tr√¨</h3>
                <table class="table maintenance-table" id="tblStaff">
                    <thead>
                        <tr>
                            <th>M√£ NV</th>
                            <th>H·ªç t√™n</th>
                            <th>Ch·ª©c v·ª•</th>
                            <th>Chuy√™n m√¥n</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>C√¥ng vi·ªác hi·ªán t·∫°i</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </main>
    </div>

    <script src="assets/js/storage.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        guardAuthenticated();
        const current = getCurrentUser();
        if (current.role !== 'Admin') document.getElementById('navUsers').style.display = 'none';

        // Kh·ªüi t·∫°o d·ªØ li·ªáu
        const warehouses = storage.get('warehouses', []);
        const maintenancePlans = storage.get('maintenancePlans', []);
        const incidents = storage.get('incidents', []);
        const maintenanceStaff = storage.get('maintenanceStaff', []);

        // C·∫≠p nh·∫≠t th·ªëng k√™ nhanh
        function updateQuickStats() {
            const totalMaintenance = maintenancePlans.length;
            const pendingMaintenance = maintenancePlans.filter(m => m.status === 'PENDING').length;
            const inProgressMaintenance = maintenancePlans.filter(m => m.status === 'INPROGRESS').length;
            const completedMaintenance = maintenancePlans.filter(m => m.status === 'COMPLETED').length;

            document.getElementById('totalMaintenance').textContent = totalMaintenance.toLocaleString('vi-VN');
            document.getElementById('pendingMaintenance').textContent = pendingMaintenance.toLocaleString('vi-VN');
            document.getElementById('inProgressMaintenance').textContent = inProgressMaintenance.toLocaleString('vi-VN');
            document.getElementById('completedMaintenance').textContent = completedMaintenance.toLocaleString('vi-VN');
        }

        // Kh·ªüi t·∫°o form
        function initializeForms() {
            // Populate warehouse selects
            const warehouseOptions = warehouses.map(w => 
                `<option value="${w.id}">${w.code} - ${w.name}</option>`
            ).join('');
            
            ['maintenanceWh', 'trackMaintenance', 'incidentWh'].forEach(id => {
                if (document.getElementById(id)) {
                    document.getElementById(id).innerHTML = '<option value="">Ch·ªçn kho...</option>' + warehouseOptions;
                }
            });

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            ['maintenanceStartDate', 'maintenanceEndDate', 'trackUpdateDate'].forEach(id => {
                if (document.getElementById(id)) {
                    document.getElementById(id).value = today;
                }
            });

            // Set default incident time
            if (document.getElementById('incidentTime')) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('incidentTime').value = now.toISOString().slice(0, 16);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeForms();
            updateQuickStats();
        });

        // Refresh button
        document.getElementById('btnRefresh').addEventListener('click', function() {
            updateQuickStats();
            alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu!');
        });
    </script>
</body>
</html>
