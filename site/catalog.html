<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh m·ª•c - Qu·∫£n l√Ω kho</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <a href="home.html">Trang ch·ªß</a>
        <a href="catalog.html" class="active">Danh m·ª•c</a>
        <a href="operations.html">Nghi·ªáp v·ª• kho</a>
        <a href="reports.html">B√°o c√°o</a>
        <a href="users.html" id="navUsers">Ng∆∞·ªùi d√πng</a>
        <a href="search.html">Tra c·ª©u</a>
        <a href="customers.html">Kh√°ch h√†ng</a>
        <a href="invoices.html">H√≥a ƒë∆°n</a>
      </aside>
      <main class="content">
        <header class="page-header">
          <h1>Qu·∫£n l√Ω danh m·ª•c</h1>
          <div class="grow"></div>
          <a href="qr-demo.html" class="btn secondary" target="_blank">üì± Demo QR</a>
          <button id="btnAddProduct" class="btn primary">+ S·∫£n ph·∫©m</button>
          <button id="btnAddSku" class="btn">+ M√£ h√†ng</button>
          <button id="btnAddUom" class="btn">+ ƒê∆°n v·ªã t√≠nh</button>
          <button id="btnAddWarehouse" class="btn">+ Kho</button>
          <button id="btnAddLocation" class="btn">+ V·ªã tr√≠</button>
          <button id="btnExport" class="btn secondary">Xu·∫•t CSV</button>
        </header>

        <section class="panel">
          <h2>S·∫£n ph·∫©m</h2>
          <div class="row"><input id="filterProducts" placeholder="L·ªçc theo t√™n ho·∫∑c m√£..." /></div>
          <table class="table" id="tblProducts">
            <thead><tr><th>M√£</th><th>T√™n</th><th>ƒêVT</th><th>M√£ v·∫°ch</th><th>C√¥ng ty SX</th><th class="right">Thao t√°c</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="panel">
          <h2>ƒê∆°n v·ªã t√≠nh</h2>
          <table class="table" id="tblUoms">
            <thead><tr><th>M√£</th><th>T√™n</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="panel">
          <h2>M√£ h√†ng (SKU)</h2>
          <table class="table" id="tblSkus">
            <thead><tr><th>SKU</th><th>Barcode</th><th>S·∫£n ph·∫©m</th><th>M·∫∑c ƒë·ªãnh</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="panel">
          <h2>Kho & V·ªã tr√≠</h2>
          <table class="table" id="tblWarehouses">
            <thead><tr><th>M√£ kho</th><th>T√™n kho</th><th>ƒê·ªãa ƒëi·ªÉm</th><th>Di·ªán t√≠ch</th><th>L·∫°nh</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <table class="table" id="tblLocations">
            <thead><tr><th>Kho</th><th>M√£ v·ªã tr√≠</th><th>T√™n v·ªã tr√≠</th><th class="right">S·ª©c ch·ª©a</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>
      </main>
    </div>

    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="modalTitle">Th√™m</h3>
        <form id="modalForm"></form>
        <div class="row right">
          <button class="btn" id="btnClose">ƒê√≥ng</button>
          <button class="btn primary" id="btnSave">L∆∞u</button>
        </div>
      </div>
    </div>

    <script src="assets/js/storage.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
      guardAuthenticated();
      const current = getCurrentUser();
      if (current.role !== 'Admin') document.getElementById('navUsers').style.display = 'none';
      const $ = (s)=>document.querySelector(s);
      
      // H√†m t·∫°o m√£ QR cho s·∫£n ph·∫©m
      function generateProductQR(productId) {
        const products = storage.get('products', []);
        const skus = storage.get('skus', []);
        const warehouses = storage.get('warehouses', []);
        const locations = storage.get('locations', []);
        const transactions = storage.get('transactions', []);
        
        const product = products.find(p => p.id === productId);
        if (!product) {
          alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
          return;
        }
        
        // T√≠nh s·ªë l∆∞·ª£ng t·ªìn kho
        const onHand = transactions.reduce((total, tx) => {
          const lines = tx.lines.filter(l => l.productId === productId);
          return total + lines.reduce((sum, line) => {
            return sum + (tx.type === 'IN' ? line.qty : -line.qty);
          }, 0);
        }, 0);
        
        // T√¨m SKU m·∫∑c ƒë·ªãnh
        const defaultSku = skus.find(s => s.productId === productId && s.isDefault);
        
        // T·∫°o th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ m√£ h√≥a v√†o QR
        const productInfo = {
          id: product.id,
          code: product.code,
          name: product.name,
          uom: product.uom || 'C√°i',
          barcode: defaultSku?.barcode || product.barcode || '',
          sku: defaultSku?.skuCode || '',
          manufacturer: product.manufacturer || 'C√¥ng ty TNHH ABC',
          onHand: Math.max(0, onHand),
          lastUpdated: new Date().toISOString(),
          description: product.description || 'S·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cao'
        };
        
        // T·∫°o JSON string ƒë·ªÉ m√£ h√≥a
        const qrData = JSON.stringify(productInfo, null, 2);
        
        // Hi·ªÉn th·ªã modal v·ªõi m√£ QR
        showQRModal(product, productInfo, qrData);
      }
      
      // Hi·ªÉn th·ªã modal m√£ QR
      function showQRModal(product, productInfo, qrData) {
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalForm = document.getElementById('modalForm');
        
        modalTitle.textContent = `M√£ QR - ${product.name}`;
        
        // T·∫°o HTML cho modal
        modalForm.innerHTML = `
          <div class="qr-container">
            <div class="qr-info">
              <h4>Th√¥ng tin s·∫£n ph·∫©m</h4>
              <div class="info-grid">
                <div class="info-item">
                  <strong>M√£ s·∫£n ph·∫©m:</strong> ${product.code}
                </div>
                <div class="info-item">
                  <strong>T√™n s·∫£n ph·∫©m:</strong> ${product.name}
                </div>
                <div class="info-item">
                  <strong>C√¥ng ty s·∫£n xu·∫•t:</strong> ${productInfo.manufacturer}
                </div>
                <div class="info-item">
                  <strong>ƒê∆°n v·ªã t√≠nh:</strong> ${productInfo.uom}
                </div>
                <div class="info-item">
                  <strong>S·ªë l∆∞·ª£ng t·ªìn:</strong> ${productInfo.onHand.toLocaleString('vi-VN')} ${productInfo.uom}
                </div>
                <div class="info-item">
                  <strong>SKU:</strong> ${productInfo.sku || 'N/A'}
                </div>
                <div class="info-item">
                  <strong>M√£ v·∫°ch:</strong> ${productInfo.barcode || 'N/A'}
                </div>
                <div class="info-item">
                  <strong>C·∫≠p nh·∫≠t:</strong> ${new Date(productInfo.lastUpdated).toLocaleString('vi-VN')}
                </div>
              </div>
            </div>
            <div class="qr-code">
              <h4>M√£ QR</h4>
              <div id="qrcode"></div>
              <p class="qr-note">Qu√©t m√£ QR ƒë·ªÉ xem th√¥ng tin chi ti·∫øt s·∫£n ph·∫©m</p>
            </div>
          </div>
          <div class="qr-actions">
            <button type="button" class="btn secondary" onclick="downloadQR()">T·∫£i xu·ªëng QR</button>
            <button type="button" class="btn secondary" onclick="printQR()">In m√£ QR</button>
          </div>
        `;
        
        // Hi·ªÉn th·ªã modal
        modal.classList.remove('hidden');
        
        // T·∫°o m√£ QR
        setTimeout(() => {
          const qrContainer = document.getElementById('qrcode');
          if (qrContainer) {
            QRCode.toCanvas(qrContainer, qrData, {
              width: 200,
              margin: 2,
              color: {
                dark: '#000000',
                light: '#FFFFFF'
              }
            }, function (error) {
              if (error) {
                console.error('L·ªói t·∫°o m√£ QR:', error);
                qrContainer.innerHTML = '<p class="error">L·ªói t·∫°o m√£ QR</p>';
              }
            });
          }
        }, 100);
        
        // C·∫≠p nh·∫≠t n√∫t Save th√†nh Close
        const btnSave = document.getElementById('btnSave');
        btnSave.textContent = 'ƒê√≥ng';
        btnSave.className = 'btn';
        btnSave.onclick = () => modal.classList.add('hidden');
        
        // C·∫≠p nh·∫≠t n√∫t Close
        document.getElementById('btnClose').onclick = () => modal.classList.add('hidden');
      }
      
      // T·∫£i xu·ªëng m√£ QR
      function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
          const link = document.createElement('a');
          link.download = 'qr-code.png';
          link.href = canvas.toDataURL();
          link.click();
        }
      }
      
      // In m√£ QR
      function printQR() {
        const printWindow = window.open('', '_blank');
        const qrContainer = document.querySelector('.qr-container').cloneNode(true);
        printWindow.document.write(`
          <html>
            <head>
              <title>In m√£ QR</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .qr-container { display: flex; gap: 20px; }
                .qr-info { flex: 1; }
                .qr-code { flex: 1; text-align: center; }
                .info-grid { display: grid; gap: 10px; }
                .info-item { padding: 5px 0; border-bottom: 1px solid #eee; }
                canvas { max-width: 200px; height: auto; }
                @media print { body { margin: 0; } }
              </style>
            </head>
            <body>
              ${qrContainer.outerHTML}
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }
      
      function renderProducts(){
        const term = ($('#filterProducts').value||'').toLowerCase();
        const rows = storage.get('products', []).filter(p=>!term||p.code.toLowerCase().includes(term)||p.name.toLowerCase().includes(term)).map(p=>`
          <tr><td>${p.code}</td><td>${p.name}</td><td>${p.uom||''}</td><td>${p.barcode||''}</td><td>${p.manufacturer||'C√¥ng ty TNHH ABC'}</td>
            <td class=right>
              <button class="btn tiny" onclick="generateProductQR('${p.id}')" title="T·∫°o m√£ QR">üì± QR</button>
              <button class="btn tiny" onclick="editProduct('${p.id}')">S·ª≠a</button> 
              <button class="btn tiny danger" onclick="deleteProduct('${p.id}')">X√≥a</button>
            </td></tr>`).join('');
        $('#tblProducts tbody').innerHTML = rows||'<tr><td colspan=6 class=muted>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      }
      function renderWarehouses(){
        const rows = storage.get('warehouses', []).map(k=>`
          <tr><td>${k.code}</td><td>${k.name}</td><td>${k.location}</td><td class=right>${k.areaTotal||0}</td><td>${k.isCold?'C√≥':'Kh√¥ng'}</td>
            <td class=right><button class="btn tiny" onclick="editWarehouse('${k.id}')">S·ª≠a</button> <button class="btn tiny danger" onclick="deleteWarehouse('${k.id}')">X√≥a</button></td></tr>`).join('');
        $('#tblWarehouses tbody').innerHTML = rows||'<tr><td colspan=6 class=muted>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      }
      function renderLocations(){
        const whs = storage.get('warehouses', []);
        const map = new Map(whs.map(w => [w.id, `${w.code} - ${w.name}`]));
        const rows = (storage.get('locations', [])||[]).map(l => `
          <tr><td>${map.get(l.warehouseId)||''}</td><td>${l.code}</td><td>${l.name}</td><td class=right>${l.capacity||0}</td>
            <td class=right><button class="btn tiny" onclick="editLocation('${l.id}')">S·ª≠a</button> <button class="btn tiny danger" onclick="deleteLocation('${l.id}')">X√≥a</button></td></tr>`).join('');
        $('#tblLocations tbody').innerHTML = rows || '<tr><td colspan=5 class=muted>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      }
      function renderUoms(){
        const rows = (storage.get('uoms', [])||[]).map(u => `
          <tr><td>${u.code}</td><td>${u.name}</td>
            <td class=right><button class="btn tiny" onclick="editUom('${u.id}')">S·ª≠a</button> <button class="btn tiny danger" onclick="deleteUom('${u.id}')">X√≥a</button></td></tr>`).join('');
        $('#tblUoms tbody').innerHTML = rows || '<tr><td colspan=3 class=muted>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      }
      function renderSkus(){
        const prods = storage.get('products', []);
        const map = new Map(prods.map(p => [p.id, `${p.code} - ${p.name}`]));
        const rows = (storage.get('skus', [])||[]).map(s => `
          <tr><td>${s.skuCode}</td><td>${s.barcode||''}</td><td>${map.get(s.productId)||''}</td><td>${s.isDefault?'C√≥':'Kh√¥ng'}</td>
            <td class=right><button class="btn tiny" onclick="editSku('${s.id}')">S·ª≠a</button> <button class="btn tiny danger" onclick="deleteSku('${s.id}')">X√≥a</button></td></tr>`).join('');
        $('#tblSkus tbody').innerHTML = rows || '<tr><td colspan=5 class=muted>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      }
      function openModal(title, html, onSave){ $('#modalTitle').textContent=title; $('#modalForm').innerHTML=html; document.getElementById('modal').classList.remove('hidden'); document.getElementById('btnSave').onclick=()=>{onSave(new FormData($('#modalForm'))); close();}; document.getElementById('btnClose').onclick=close; function close(){document.getElementById('modal').classList.add('hidden');}}
      window.editProduct=(id)=>{ const list=storage.get('products',[]); const it=list.find(x=>x.id===id); openModal('C·∫≠p nh·∫≠t s·∫£n ph·∫©m',`
        <label>M√£</label><input name=code value="${it.code}" required />
        <label>T√™n</label><input name=name value="${it.name}" required />
        <label>ƒêVT</label><input name=uom value="${it.uom||''}" />
        <label>M√£ v·∫°ch</label><input name=barcode value="${it.barcode||''}" />
        <label>C√¥ng ty s·∫£n xu·∫•t</label><input name=manufacturer value="${it.manufacturer||'C√¥ng ty TNHH ABC'}" />
        <label>M√¥ t·∫£</label><textarea name=description rows=3>${it.description||''}</textarea>`,fd=>{it.code=fd.get('code');it.name=fd.get('name');it.uom=fd.get('uom');it.barcode=fd.get('barcode');it.manufacturer=fd.get('manufacturer');it.description=fd.get('description');storage.set('products',list);renderProducts();}); };
      window.deleteProduct=(id)=>{ if(!confirm('X√≥a s·∫£n ph·∫©m n√†y?'))return; const list=storage.get('products',[]).filter(x=>x.id!==id); storage.set('products',list); renderProducts(); };
      document.getElementById('btnAddProduct').onclick=()=>openModal('Th√™m s·∫£n ph·∫©m',`
        <label>M√£</label><input name=code required />
        <label>T√™n</label><input name=name required />
        <label>ƒêVT</label><input name=uom />
        <label>M√£ v·∫°ch</label><input name=barcode />
        <label>C√¥ng ty s·∫£n xu·∫•t</label><input name=manufacturer value="C√¥ng ty TNHH ABC" />
        <label>M√¥ t·∫£</label><textarea name=description rows=3></textarea>`,fd=>{ const list=storage.get('products',[]); list.push({id:crypto.randomUUID(), code:fd.get('code'), name:fd.get('name'), uom:fd.get('uom'), barcode:fd.get('barcode'), manufacturer:fd.get('manufacturer'), description:fd.get('description')}); storage.set('products',list); renderProducts(); });
      window.editWarehouse=(id)=>{ const list=storage.get('warehouses',[]); const k=list.find(x=>x.id===id); openModal('C·∫≠p nh·∫≠t kho',`
        <label>M√£ kho</label><input name=code value="${k.code}" required />
        <label>T√™n kho</label><input name=name value="${k.name}" required />
        <label>ƒê·ªãa ƒëi·ªÉm</label><input name=location value="${k.location}" required />
        <label>Di·ªán t√≠ch (m¬≤)</label><input type=number step=0.01 name=areaTotal value="${k.areaTotal}" />
        <label><input type=checkbox name=isCold ${k.isCold?'checked':''}/> Kho l·∫°nh</label>`,fd=>{k.code=fd.get('code');k.name=fd.get('name');k.location=fd.get('location');k.areaTotal=Number(fd.get('areaTotal')||0);k.isCold=fd.get('isCold')==='on'; storage.set('warehouses',list); renderWarehouses();}); };
      window.deleteWarehouse=(id)=>{ if(!confirm('X√≥a kho n√†y?'))return; const list=storage.get('warehouses',[]).filter(x=>x.id!==id); storage.set('warehouses',list); renderWarehouses(); };
      document.getElementById('btnAddWarehouse').onclick=()=>openModal('Th√™m kho',`
        <label>M√£ kho</label><input name=code required />
        <label>T√™n kho</label><input name=name required />
        <label>ƒê·ªãa ƒëi·ªÉm</label><input name=location required />
        <label>Di·ªán t√≠ch (m¬≤)</label><input type=number step=0.01 name=areaTotal />
        <label><input type=checkbox name=isCold /> Kho l·∫°nh</label>`,fd=>{ const list=storage.get('warehouses',[]); list.push({id:crypto.randomUUID(), code:fd.get('code'), name:fd.get('name'), location:fd.get('location'), areaTotal:Number(fd.get('areaTotal')||0), isCold:fd.get('isCold')==='on'}); storage.set('warehouses',list); renderWarehouses();});
      // CRUD V·ªã tr√≠
      window.editLocation = (id) => {
        const list = storage.get('locations', [])||[]; const l = list.find(x => x.id === id);
        const whs = storage.get('warehouses', []);
        openModal('C·∫≠p nh·∫≠t v·ªã tr√≠', `
          <label>Kho</label><select name=warehouseId>${whs.map(w=>`<option value="${w.id}" ${w.id===l.warehouseId?'selected':''}>${w.code} - ${w.name}</option>`).join('')}</select>
          <label>M√£ v·ªã tr√≠</label><input name=code value="${l.code}" required />
          <label>T√™n v·ªã tr√≠</label><input name=name value="${l.name}" />
          <label>S·ª©c ch·ª©a</label><input type=number step=1 name=capacity value="${l.capacity||0}" />
        `, fd => {
          l.warehouseId = fd.get('warehouseId'); l.code = fd.get('code'); l.name = fd.get('name'); l.capacity = Number(fd.get('capacity')||0);
          storage.set('locations', list); renderLocations();
        });
      };
      window.deleteLocation = (id) => { if (!confirm('X√≥a v·ªã tr√≠ n√†y?')) return; const list=(storage.get('locations',[])||[]).filter(x=>x.id!==id); storage.set('locations', list); renderLocations(); };
      document.getElementById('btnAddLocation').onclick = () => {
        const whs = storage.get('warehouses', []);
        openModal('Th√™m v·ªã tr√≠', `
          <label>Kho</label><select name=warehouseId>${whs.map(w=>`<option value="${w.id}">${w.code} - ${w.name}</option>`).join('')}</select>
          <label>M√£ v·ªã tr√≠</label><input name=code required />
          <label>T√™n v·ªã tr√≠</label><input name=name />
          <label>S·ª©c ch·ª©a</label><input type=number step=1 name=capacity />
        `, fd => {
          const list = storage.get('locations', [])||[];
          list.push({ id: crypto.randomUUID(), warehouseId: fd.get('warehouseId'), code: fd.get('code'), name: fd.get('name'), capacity: Number(fd.get('capacity')||0) });
          storage.set('locations', list); renderLocations();
        });
      };

      // CRUD UOM
      window.editUom = (id) => { const list = storage.get('uoms', []); const u = list.find(x=>x.id===id); openModal('C·∫≠p nh·∫≠t ƒêVT', `
          <label>M√£</label><input name=code value="${u.code}" required />
          <label>T√™n</label><input name=name value="${u.name}" required />
        `, fd => { u.code = fd.get('code'); u.name = fd.get('name'); storage.set('uoms', list); renderUoms(); }); };
      window.deleteUom = (id) => { if (!confirm('X√≥a ƒêVT n√†y?')) return; const list=storage.get('uoms',[]).filter(x=>x.id!==id); storage.set('uoms', list); renderUoms(); };
      document.getElementById('btnAddUom').onclick = () => openModal('Th√™m ƒêVT', `
          <label>M√£</label><input name=code required />
          <label>T√™n</label><input name=name required />
        `, fd => { const list = storage.get('uoms', []); list.push({ id: crypto.randomUUID(), code: fd.get('code'), name: fd.get('name') }); storage.set('uoms', list); renderUoms(); });

      // CRUD SKU
      window.editSku = (id) => { const list = storage.get('skus', []); const s = list.find(x=>x.id===id); const prods = storage.get('products', []); openModal('C·∫≠p nh·∫≠t m√£ h√†ng', `
          <label>S·∫£n ph·∫©m</label><select name=productId>${prods.map(p=>`<option value="${p.id}" ${p.id===s.productId?'selected':''}>${p.code} - ${p.name}</option>`).join('')}</select>
          <label>SKU</label><input name=skuCode value="${s.skuCode}" required />
          <label>Barcode</label><input name=barcode value="${s.barcode||''}" />
          <label><input type=checkbox name=isDefault ${s.isDefault?'checked':''}/> M·∫∑c ƒë·ªãnh</label>
        `, fd => { s.productId = fd.get('productId'); s.skuCode = fd.get('skuCode'); s.barcode = fd.get('barcode'); s.isDefault = fd.get('isDefault')==='on'; storage.set('skus', list); renderSkus(); }); };
      window.deleteSku = (id) => { if (!confirm('X√≥a m√£ h√†ng n√†y?')) return; const list=storage.get('skus',[]).filter(x=>x.id!==id); storage.set('skus', list); renderSkus(); };
      document.getElementById('btnAddSku').onclick = () => { const prods = storage.get('products', []); openModal('Th√™m m√£ h√†ng', `
          <label>S·∫£n ph·∫©m</label><select name=productId>${prods.map(p=>`<option value=\"${p.id}\">${p.code} - ${p.name}</option>`).join('')}</select>
          <label>SKU</label><input name=skuCode required />
          <label>Barcode</label><input name=barcode />
          <label><input type=checkbox name=isDefault /> M·∫∑c ƒë·ªãnh</label>
        `, fd => { const list = storage.get('skus', []); list.push({ id: crypto.randomUUID(), productId: fd.get('productId'), skuCode: fd.get('skuCode'), barcode: fd.get('barcode'), isDefault: fd.get('isDefault')==='on' }); storage.set('skus', list); renderSkus(); }); };
      document.getElementById('btnExport').onclick=()=>{ const rows=storage.get('products',[]); const csv=['code,name,uom,barcode'].concat(rows.map(r=>[r.code,r.name,r.uom||'',r.barcode||''].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(','))).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='products.csv'; a.click(); };
      document.getElementById('filterProducts').addEventListener('input',renderProducts);
      renderProducts(); renderUoms(); renderSkus(); renderWarehouses(); renderLocations();
    </script>
  </body>
  </html>


